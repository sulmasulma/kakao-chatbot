"""Check if a host is in the Google Chrome HSTS Preload list"""

import functools
import os
import typing

__version__ = "2020.6.30"
__checksum__ = "50a8c2eb46e3b33e76f199b2fbc653dcbcb3ce6d4451996844d4ee5f33dfec8e"
__all__ = ["in_hsts_preload"]

# fmt: off
_GTLD_INCLUDE_SUBDOMAINS = {b'android', b'app', b'bank', b'chrome', b'dev', b'foo', b'gle', b'gmail', b'google', b'hangout', b'insurance', b'meet', b'new', b'page', b'play', b'search', b'youtube'}  # noqa: E501
_JUMPTABLE = [[(0, 11), (11, 5), None, (16, 57), (73, 26), (99, 12), None, (111, 19), (130, 11), (141, 7), (148, 20), (168, 18), None, (186, 22), (208, 45), (253, 7), (260, 9), (269, 36), (305, 10), (315, 10), (325, 21), None, (346, 50), (396, 8), (404, 9), (413, 11), (424, 13), (437, 14), (451, 14), None, None, (465, 29), (494, 16), (510, 35), (545, 14), (559, 24), (583, 9), None, (592, 17), (609, 20), (629, 8), (637, 13), (650, 10), None, (660, 11), (671, 6), (677, 26), (703, 5), (708, 5), (713, 10), (723, 10), (733, 11), (744, 12), (756, 27), None, (783, 11), (794, 11), (805, 7), (812, 29), (841, 18), (859, 27), (886, 46), (932, 25), (957, 16), (973, 8), (981, 5), (986, 22), (1008, 18), None, (1026, 36), (1062, 15), (1077, 8), (1085, 5), None, (1090, 5), (1095, 16), (1111, 14), (1125, 18), None, (1143, 14), (1157, 18), (1175, 48), (1223, 19), (1242, 5), (1247, 46), (1293, 14), (1307, 14), (1321, 20), None, (1341, 10), (1351, 13), (1364, 10), (1374, 19), None, (1393, 13), (1406, 19), (1425, 5), (1430, 4), (1434, 22), (1456, 10), (1466, 7), (1473, 14), (1487, 21), (1508, 11), (1519, 10), (1529, 12), (1541, 32), None, (1573, 10), (1583, 14), (1597, 12), (1609, 45), (1654, 15), None, (1669, 11), (1680, 23), (1703, 21), (1724, 26), (1750, 6), (1756, 6), (1762, 7), (1769, 5), (1774, 20), (1794, 23), (1817, 24), (1841, 13), (1854, 15), (1869, 19), (1888, 6), (1894, 61), (1955, 44), (1999, 12), (2011, 23), (2034, 16), (2050, 38), (2088, 6), (2094, 12), (2106, 44), (2150, 6), (2156, 41), (2197, 13), (2210, 23), (2233, 30), (2263, 16), (2279, 8), (2287, 6), (2293, 12), (2305, 19), (2324, 21), (2345, 15), None, (2360, 35), (2395, 21), (2416, 17), (2433, 19), (2452, 26), (2478, 5), (2483, 37), (2520, 30), (2550, 16), (2566, 10), (2576, 17), (2593, 23), (2616, 14), (2630, 17), (2647, 8), (2655, 4), (2659, 7), (2666, 29), (2695, 6), (2701, 18), (2719, 27), (2746, 20), (2766, 17), (2783, 19), (2802, 12), (2814, 40), (2854, 40), (2894, 12), (2906, 48), (2954, 25), (2979, 12), None, (2991, 8), (2999, 20), (3019, 12), (3031, 6), (3037, 23), None, (3060, 23), (3083, 33), (3116, 14), (3130, 12), (3142, 27), None, (3169, 26), (3195, 31), (3226, 50), (3276, 15), (3291, 20), (3311, 15), (3326, 21), (3347, 32), (3379, 24), (3403, 20), (3423, 13), (3436, 60), (3496, 19), (3515, 9), (3524, 12), (3536, 12), (3548, 11), (3559, 10), (3569, 48), (3617, 32), None, (3649, 25), (3674, 12), None, (3686, 8), (3694, 8), (3702, 7), None, (3709, 25), (3734, 17), None, (3751, 21), (3772, 35), (3807, 12), (3819, 10), (3829, 36), (3865, 20), (3885, 22), (3907, 23), (3930, 19), (3949, 12), (3961, 5), (3966, 30), (3996, 24), (4020, 14), (4034, 14), (4048, 47), (4095, 46), None, None, (4141, 51), (4192, 42), None, (4234, 14), None, (4248, 15), (4263, 8), (4271, 21), (4292, 6), (4298, 16), (4314, 17)], [(4331, 5999), (10330, 6483), (16813, 6896), (23709, 5668), (29377, 6107), (35484, 5748), (41232, 6723), (47955, 5906), (53861, 6503), (60364, 5895), (66259, 6853), (73112, 6101), (79213, 6567), (85780, 6923), (92703, 6427), (99130, 6305), (105435, 6885), (112320, 5827), (118147, 6079), (124226, 6411), (130637, 6715), (137352, 6392), (143744, 6634), (150378, 5876), (156254, 6058), (162312, 6463), (168775, 6407), (175182, 6687), (181869, 6150), (188019, 6302), (194321, 6614), (200935, 6315), (207250, 6240), (213490, 6847), (220337, 5926), (226263, 6700), (232963, 6043), (239006, 6806), (245812, 6490), (252302, 6831), (259133, 7175), (266308, 6105), (272413, 6154), (278567, 5959), (284526, 5920), (290446, 5787), (296233, 6108), (302341, 6747), (309088, 6159), (315247, 5523), (320770, 6263), (327033, 6405), (333438, 6348), (339786, 6537), (346323, 6630), (352953, 6586), (359539, 6629), (366168, 5624), (371792, 6610), (378402, 5624), (384026, 6382), (390408, 6214), (396622, 6127), (402749, 6613), (409362, 6427), (415789, 6389), (422178, 5815), (427993, 6745), (434738, 6514), (441252, 6614), (447866, 6239), (454105, 6256), (460361, 5548), (465909, 6818), (472727, 6790), (479517, 6712), (486229, 5928), (492157, 6996), (499153, 6900), (506053, 5884), (511937, 6485), (518422, 5562), (523984, 6159), (530143, 6387), (536530, 6304), (542834, 6266), (549100, 6437), (555537, 6453), (561990, 6520), (568510, 6234), (574744, 7011), (581755, 5892), (587647, 5987), (593634, 6374), (600008, 6300), (606308, 6778), (613086, 6636), (619722, 6220), (625942, 6098), (632040, 5979), (638019, 5992), (644011, 6615), (650626, 6049), (656675, 6157), (662832, 5932), (668764, 6638), (675402, 6227), (681629, 6736), (688365, 7825), (696190, 6837), (703027, 6722), (709749, 6214), (715963, 6092), (722055, 6506), (728561, 6756), (735317, 6312), (741629, 6043), (747672, 6252), (753924, 6241), (760165, 6701), (766866, 6615), (773481, 6561), (780042, 6946), (786988, 6555), (793543, 7666), (801209, 6239), (807448, 5519), (812967, 6754), (819721, 6437), (826158, 7760), (833918, 6724), (840642, 6028), (846670, 6527), (853197, 6661), (859858, 6140), (865998, 6589), (872587, 5788), (878375, 6590), (884965, 6223), (891188, 6350), (897538, 6282), (903820, 6966), (910786, 6091), (916877, 6083), (922960, 6403), (929363, 6305), (935668, 6218), (941886, 6696), (948582, 5930), (954512, 6829), (961341, 6444), (967785, 6498), (974283, 6586), (980869, 6300), (987169, 6325), (993494, 6242), (999736, 6211), (1005947, 6198), (1012145, 6016), (1018161, 5607), (1023768, 5920), (1029688, 6414), (1036102, 7000), (1043102, 5933), (1049035, 6342), (1055377, 6785), (1062162, 6185), (1068347, 5952), (1074299, 6617), (1080916, 6314), (1087230, 5739), (1092969, 6367), (1099336, 7407), (1106743, 5835), (1112578, 6025), (1118603, 6508), (1125111, 6081), (1131192, 6440), (1137632, 6106), (1143738, 5846), (1149584, 7105), (1156689, 6552), (1163241, 6217), (1169458, 6656), (1176114, 7035), (1183149, 7093), (1190242, 6009), (1196251, 6776), (1203027, 6103), (1209130, 6452), (1215582, 6546), (1222128, 5962), (1228090, 6608), (1234698, 6742), (1241440, 6410), (1247850, 6245), (1254095, 6163), (1260258, 6216), (1266474, 6564), (1273038, 5947), (1278985, 6432), (1285417, 5759), (1291176, 6861), (1298037, 6744), (1304781, 6485), (1311266, 6679), (1317945, 5566), (1323511, 6495), (1330006, 6313), (1336319, 6455), (1342774, 6631), (1349405, 6828), (1356233, 6282), (1362515, 6422), (1368937, 6550), (1375487, 6243), (1381730, 6260), (1387990, 6359), (1394349, 6434), (1400783, 6074), (1406857, 6300), (1413157, 5811), (1418968, 7022), (1425990, 6451), (1432441, 6138), (1438579, 6566), (1445145, 6416), (1451561, 5613), (1457174, 6397), (1463571, 6347), (1469918, 7262), (1477180, 6193), (1483373, 5703), (1489076, 6812), (1495888, 6202), (1502090, 6797), (1508887, 5923), (1514810, 6027), (1520837, 5716), (1526553, 6510), (1533063, 6268), (1539331, 6661), (1545992, 6038), (1552030, 6432), (1558462, 6203), (1564665, 6853), (1571518, 6232), (1577750, 5627), (1583377, 6358), (1589735, 6075), (1595810, 6453), (1602263, 6625), (1608888, 7006), (1615894, 6076), (1621970, 6110), (1628080, 6522)], [(1634602, 703), (1635305, 605), (1635910, 628), (1636538, 645), (1637183, 491), (1637674, 611), (1638285, 665), (1638950, 808), (1639758, 652), (1640410, 627), (1641037, 509), (1641546, 532), (1642078, 741), (1642819, 888), (1643707, 919), (1644626, 714), (1645340, 1188), (1646528, 589), (1647117, 829), (1647946, 640), (1648586, 733), (1649319, 688), (1650007, 802), (1650809, 709), (1651518, 684), (1652202, 631), (1652833, 910), (1653743, 1009), (1654752, 768), (1655520, 657), (1656177, 915), (1657092, 758), (1657850, 538), (1658388, 671), (1659059, 712), (1659771, 693), (1660464, 619), (1661083, 677), (1661760, 692), (1662452, 929), (1663381, 683), (1664064, 823), (1664887, 660), (1665547, 671), (1666218, 710), (1666928, 362), (1667290, 763), (1668053, 857), (1668910, 673), (1669583, 525), (1670108, 789), (1670897, 617), (1671514, 763), (1672277, 935), (1673212, 896), (1674108, 464), (1674572, 661), (1675233, 486), (1675719, 578), (1676297, 662), (1676959, 716), (1677675, 753), (1678428, 1008), (1679436, 813), (1680249, 602), (1680851, 692), (1681543, 753), (1682296, 444), (1682740, 540), (1683280, 487), (1683767, 692), (1684459, 789), (1685248, 521), (1685769, 706), (1686475, 634), (1687109, 671), (1687780, 552), (1688332, 680), (1689012, 752), (1689764, 428), (1690192, 653), (1690845, 607), (1691452, 828), (1692280, 623), (1692903, 588), (1693491, 282), (1693773, 597), (1694370, 691), (1695061, 741), (1695802, 647), (1696449, 794), (1697243, 1100), (1698343, 788), (1699131, 723), (1699854, 674), (1700528, 436), (1700964, 890), (1701854, 835), (1702689, 564), (1703253, 580), (1703833, 666), (1704499, 843), (1705342, 839), (1706181, 522), (1706703, 632), (1707335, 653), (1707988, 363), (1708351, 467), (1708818, 924), (1709742, 825), (1710567, 792), (1711359, 737), (1712096, 584), (1712680, 749), (1713429, 643), (1714072, 683), (1714755, 668), (1715423, 448), (1715871, 639), (1716510, 588), (1717098, 914), (1718012, 668), (1718680, 789), (1719469, 404), (1719873, 703), (1720576, 656), (1721232, 835), (1722067, 883), (1722950, 761), (1723711, 904), (1724615, 747), (1725362, 502), (1725864, 757), (1726621, 583), (1727204, 737), (1727941, 715), (1728656, 624), (1729280, 682), (1729962, 589), (1730551, 613), (1731164, 594), (1731758, 691), (1732449, 671), (1733120, 657), (1733777, 401), (1734178, 549), (1734727, 641), (1735368, 556), (1735924, 683), (1736607, 594), (1737201, 744), (1737945, 520), (1738465, 490), (1738955, 656), (1739611, 551), (1740162, 607), (1740769, 623), (1741392, 796), (1742188, 594), (1742782, 609), (1743391, 841), (1744232, 826), (1745058, 522), (1745580, 695), (1746275, 796), (1747071, 607), (1747678, 659), (1748337, 459), (1748796, 580), (1749376, 621), (1749997, 714), (1750711, 578), (1751289, 883), (1752172, 676), (1752848, 811), (1753659, 683), (1754342, 636), (1754978, 518), (1755496, 629), (1756125, 699), (1756824, 1277), (1758101, 514), (1758615, 641), (1759256, 608), (1759864, 944), (1760808, 730), (1761538, 716), (1762254, 528), (1762782, 565), (1763347, 808), (1764155, 553), (1764708, 569), (1765277, 826), (1766103, 650), (1766753, 856), (1767609, 772), (1768381, 668), (1769049, 646), (1769695, 783), (1770478, 620), (1771098, 889), (1771987, 631), (1772618, 722), (1773340, 534), (1773874, 689), (1774563, 449), (1775012, 753), (1775765, 761), (1776526, 648), (1777174, 881), (1778055, 775), (1778830, 731), (1779561, 903), (1780464, 1037), (1781501, 815), (1782316, 586), (1782902, 839), (1783741, 662), (1784403, 483), (1784886, 443), (1785329, 692), (1786021, 774), (1786795, 406), (1787201, 951), (1788152, 462), (1788614, 741), (1789355, 844), (1790199, 712), (1790911, 769), (1791680, 626), (1792306, 730), (1793036, 665), (1793701, 691), (1794392, 546), (1794938, 566), (1795504, 410), (1795914, 586), (1796500, 437), (1796937, 740), (1797677, 815), (1798492, 740), (1799232, 700), (1799932, 621), (1800553, 568), (1801121, 808), (1801929, 406), (1802335, 518), (1802853, 736), (1803589, 513), (1804102, 839), (1804941, 2071), (1807012, 507), (1807519, 602), (1808121, 875), (1808996, 817), (1809813, 510)], [(1810323, 48), None, (1810371, 35), (1810406, 42), None, None, None, None, None, None, None, None, None, None, None, None, None, (1810448, 42), None, (1810490, 25), (1810515, 16), None, None, None, None, None, None, (1810531, 26), None, None, None, None, (1810557, 21), (1810578, 25), None, None, (1810603, 26), None, None, None, None, (1810629, 44), (1810673, 21), (1810694, 23), None, None, None, None, (1810717, 48), None, None, None, None, None, (1810765, 31), None, None, None, None, (1810796, 42), None, (1810838, 22), None, (1810860, 21), None, (1810881, 26), (1810907, 42), None, None, (1810949, 77), None, None, None, None, None, (1811026, 21), (1811047, 21), None, None, (1811068, 34), (1811102, 42), None, None, None, (1811144, 25), None, None, (1811169, 21), None, None, None, None, None, (1811190, 24), (1811214, 21), None, None, (1811235, 26), None, (1811261, 18), None, (1811279, 54), None, None, None, None, None, None, (1811333, 26), None, (1811359, 19), None, (1811378, 20), None, None, (1811398, 42), (1811440, 42), (1811482, 17), None, (1811499, 26), None, (1811525, 26), None, None, None, (1811551, 26), (1811577, 20), (1811597, 26), None, (1811623, 42), (1811665, 63), None, None, None, (1811728, 40), (1811768, 48), None, None, None, (1811816, 47), None, None, None, None, None, None, None, (1811863, 42), None, (1811905, 55), None, (1811960, 9), None, (1811969, 21), (1811990, 42), None, None, (1812032, 42), (1812074, 82), None, None, (1812156, 42), None, None, None, None, None, None, None, None, None, (1812198, 42), (1812240, 21), (1812261, 21), None, (1812282, 42), (1812324, 25), None, None, (1812349, 21), (1812370, 42), None, None, (1812412, 21), (1812433, 19), (1812452, 26), None, None, None, (1812478, 21), None, None, (1812499, 38), None, (1812537, 22), (1812559, 21), (1812580, 21), None, None, (1812601, 63), None, (1812664, 21), (1812685, 42), None, (1812727, 17), None, None, None, None, (1812744, 21), (1812765, 21), None, None, (1812786, 21), None, None, (1812807, 21), None, (1812828, 26), None, (1812854, 50), None, None, None, (1812904, 50), (1812954, 26), (1812980, 21), (1813001, 21), (1813022, 19), None, (1813041, 35), (1813076, 26), (1813102, 23), (1813125, 21), (1813146, 42), None, None, None, None, None, None, (1813188, 21), None, None, None, (1813209, 21), None, None, (1813230, 90), None, (1813320, 239), (1813559, 38), None, None, None, None]]  # noqa: E501
_CRC8_TABLE = [
    0x00, 0x07, 0x0e, 0x09, 0x1c, 0x1b, 0x12, 0x15,
    0x38, 0x3f, 0x36, 0x31, 0x24, 0x23, 0x2a, 0x2d,
    0x70, 0x77, 0x7e, 0x79, 0x6c, 0x6b, 0x62, 0x65,
    0x48, 0x4f, 0x46, 0x41, 0x54, 0x53, 0x5a, 0x5d,
    0xe0, 0xe7, 0xee, 0xe9, 0xfc, 0xfb, 0xf2, 0xf5,
    0xd8, 0xdf, 0xd6, 0xd1, 0xc4, 0xc3, 0xca, 0xcd,
    0x90, 0x97, 0x9e, 0x99, 0x8c, 0x8b, 0x82, 0x85,
    0xa8, 0xaf, 0xa6, 0xa1, 0xb4, 0xb3, 0xba, 0xbd,
    0xc7, 0xc0, 0xc9, 0xce, 0xdb, 0xdc, 0xd5, 0xd2,
    0xff, 0xf8, 0xf1, 0xf6, 0xe3, 0xe4, 0xed, 0xea,
    0xb7, 0xb0, 0xb9, 0xbe, 0xab, 0xac, 0xa5, 0xa2,
    0x8f, 0x88, 0x81, 0x86, 0x93, 0x94, 0x9d, 0x9a,
    0x27, 0x20, 0x29, 0x2e, 0x3b, 0x3c, 0x35, 0x32,
    0x1f, 0x18, 0x11, 0x16, 0x03, 0x04, 0x0d, 0x0a,
    0x57, 0x50, 0x59, 0x5e, 0x4b, 0x4c, 0x45, 0x42,
    0x6f, 0x68, 0x61, 0x66, 0x73, 0x74, 0x7d, 0x7a,
    0x89, 0x8e, 0x87, 0x80, 0x95, 0x92, 0x9b, 0x9c,
    0xb1, 0xb6, 0xbf, 0xb8, 0xad, 0xaa, 0xa3, 0xa4,
    0xf9, 0xfe, 0xf7, 0xf0, 0xe5, 0xe2, 0xeb, 0xec,
    0xc1, 0xc6, 0xcf, 0xc8, 0xdd, 0xda, 0xd3, 0xd4,
    0x69, 0x6e, 0x67, 0x60, 0x75, 0x72, 0x7b, 0x7c,
    0x51, 0x56, 0x5f, 0x58, 0x4d, 0x4a, 0x43, 0x44,
    0x19, 0x1e, 0x17, 0x10, 0x05, 0x02, 0x0b, 0x0c,
    0x21, 0x26, 0x2f, 0x28, 0x3d, 0x3a, 0x33, 0x34,
    0x4e, 0x49, 0x40, 0x47, 0x52, 0x55, 0x5c, 0x5b,
    0x76, 0x71, 0x78, 0x7f, 0x6a, 0x6d, 0x64, 0x63,
    0x3e, 0x39, 0x30, 0x37, 0x22, 0x25, 0x2c, 0x2b,
    0x06, 0x01, 0x08, 0x0f, 0x1a, 0x1d, 0x14, 0x13,
    0xae, 0xa9, 0xa0, 0xa7, 0xb2, 0xb5, 0xbc, 0xbb,
    0x96, 0x91, 0x98, 0x9f, 0x8a, 0x8d, 0x84, 0x83,
    0xde, 0xd9, 0xd0, 0xd7, 0xc2, 0xc5, 0xcc, 0xcb,
    0xe6, 0xe1, 0xe8, 0xef, 0xfa, 0xfd, 0xf4, 0xf3
]
# fmt: on

_IS_LEAF = 0x80
_INCLUDE_SUBDOMAINS = 0x40


try:
    from importlib.resources import open_binary

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open_binary("hstspreload", path)


except ImportError:

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open(
            os.path.join(os.path.dirname(os.path.abspath(__file__)), path), "rb",
        )


@functools.lru_cache(maxsize=1024)
def in_hsts_preload(host: typing.AnyStr) -> bool:
    """Determines if an IDNA-encoded host is on the HSTS preload list"""

    if isinstance(host, str):
        host = host.encode("ascii")
    labels = host.lower().split(b".")

    # Fast-branch for gTLDs that are registered to preload all sub-domains.
    if labels[-1] in _GTLD_INCLUDE_SUBDOMAINS:
        return True

    with open_pkg_binary("hstspreload.bin") as f:
        for layer, label in enumerate(labels[::-1]):
            # None of our layers are greater than 4 deep.
            if layer > 3:
                return False

            # Read the jump table for the layer and label
            jump_info = _JUMPTABLE[layer][_crc8(label)]
            if jump_info is None:
                # No entry: host is not preloaded
                return False

            # Read the set of entries for that layer and label
            f.seek(jump_info[0])
            data = bytearray(jump_info[1])
            f.readinto(data)

            for is_leaf, include_subdomains, ent_label in _iter_entries(data):
                # We found a potential leaf
                if is_leaf:
                    if ent_label == host:
                        return True
                    if include_subdomains and host.endswith(b"." + ent_label):
                        return True

                # Continue traversing as we're not at a leaf.
                elif label == ent_label:
                    break
            else:
                return False
    return False


def _iter_entries(data: bytes) -> typing.Iterable[typing.Tuple[int, int, bytes]]:
    while data:
        flags = data[0]
        size = data[1]
        label = bytes(data[2 : 2 + size])
        yield (flags & _IS_LEAF, flags & _INCLUDE_SUBDOMAINS, label)
        data = data[2 + size :]


def _crc8(value: bytes) -> int:
    # CRC8 reference implementation: https://github.com/niccokunzmann/crc8
    checksum = 0x00
    for byte in value:
        checksum = _CRC8_TABLE[checksum ^ byte]
    return checksum
